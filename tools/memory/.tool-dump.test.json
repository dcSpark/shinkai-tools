{"type":"Deno","content":[{"name":"Memory Management","homepage":null,"author":"@@official.shinkai","version":"1.0.0","mcp_enabled":null,"js_code":"import { shinkaiSqliteQueryExecutor as shinkaiSqliteQueryExecutor_ } from \"./shinkai-local-tools.ts\";\nimport { shinkaiLlmPromptProcessor } from \"./shinkai-local-tools.ts\";\n\nconst shinkaiSqliteQueryExecutor = (params: any) => {\n  console.log(\"shinkaiSqliteQueryExecutor\", params);\n  return shinkaiSqliteQueryExecutor_(params);\n};\n\ntype CONFIG = {\n  database_name?: string;\n};\ntype INPUTS = {\n  data?: string;\n  general_prompt?: string;\n  specific_prompt?: string;\n  key?: string;\n};\ntype OUTPUT = {\n  generalMemory: string;\n  specificMemory: string;\n};\n\nconst createTable = async (\n  database_name: string | undefined\n): Promise<void> => {\n  // Create table if not exists\n  const createTableQuery = `\n        CREATE TABLE IF NOT EXISTS memory_table (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            date DATETIME DEFAULT CURRENT_TIMESTAMP,\n            key TEXT,\n            memory TEXT\n        );\n    `;\n  await shinkaiSqliteQueryExecutor({\n    query: createTableQuery,\n    ...(database_name && { database_name }),\n  });\n};\n\nconst getGeneralMemory = async (\n  database_name: string | undefined\n): Promise<null | { id: number; key: string; memory: string }> => {\n  const fetchGeneralMemoryQuery = `\n      SELECT id, key, memory\n      FROM memory_table\n      where key is null\n    `;\n  const fetchGeneralMemory = await shinkaiSqliteQueryExecutor({\n    query: fetchGeneralMemoryQuery,\n    ...(database_name && { database_name }),\n  });\n\n  if (fetchGeneralMemory.result.length) {\n    return fetchGeneralMemory.result[0];\n  }\n  return null;\n};\n\nconst getSpecificMemory = async (\n  database_name: string | undefined,\n  key: string\n): Promise<null | { id: number; key: string; memory: string }> => {\n  const fetchSpecificMemoryQuery = `\n      SELECT id, key, memory\n      FROM memory_table\n      where key = ?\n    `;\n  const fetchSpecificMemory = await shinkaiSqliteQueryExecutor({\n    query: fetchSpecificMemoryQuery,\n    params: [key],\n    ...(database_name && { database_name }),\n  });\n\n  if (fetchSpecificMemory.result.length) {\n    return fetchSpecificMemory.result[0];\n  }\n  return null;\n};\n\nconst generatePrompt = async (\n  previousMemory: null | { id: number; key: string; memory: string },\n  general_prompt: string,\n  data: string\n): Promise<string> => {\n  let generalPrompt = `\n* You must generate memories, so we can recall new and past interactions.\n* Retrive past memories if there are any, and merge them with the new data.\n* We should merge new and past interactions, into a single memory.\n* We can restructure the memory to make it consistent and ordered.\n* Keep the most important information only.\n* Based on the rules tag, you must generate the output.\n\nUse \"##\" to write and identify main topics\nUse \"#\" to identify titles of definitions\n\nOnly output the new memory, without comments, suggestions or how it was generated.\n\nThis is an example on how to structure the memory, not the fields you must use.\n\\`\\`\\`\n# Location\n## NY: Latitude: 40.7128, Longitude: -74.0060\n## CO: Latitude: -33.4569, Longitude: -70.6483\n- CO has borders with Per√∫ and Bolivia\n\n# Known People\n## John: 30 years old\n## Jane: 25 years old\n## Peter: is from Europe.\n- John and Jane are friends \n\\`\\`\\`\n\nThese are some sections you must understand:\n  * rules tag: has the rules you must follow to generate the output.\\n`;\n  if (previousMemory)\n    generalPrompt += `. * previous_interactions tag: has entire previous interaction memory\\n`;\n  generalPrompt += `. * input tag: has the new data to for creating new memories.\n\n<rules>\n  ${general_prompt}\n</rules>\n    `;\n  if (previousMemory)\n    generalPrompt += `\n<previous_interactions>\n  ${previousMemory.memory}\n</previous_interactions>\n      `;\n\n  generalPrompt += `\n<input>\n  ${data}\n</input>\n    `;\n  return generalPrompt;\n};\n\nexport async function run(config: CONFIG, inputs: INPUTS): Promise<OUTPUT> {\n  const {\n    data,\n    general_prompt = \"Synthesize important information to remember from this interaction\",\n    specific_prompt = \"Synthesize important information to remember from this interaction\",\n    key,\n  } = inputs;\n\n  await createTable(config.database_name);\n  // If no data provided, just return existing memories\n  if (!data) {\n    const existingGeneralMemory = await getGeneralMemory(config.database_name);\n    const existingSpecificMemory = key\n      ? await getSpecificMemory(config.database_name, key)\n      : null;\n\n    return {\n      generalMemory: existingGeneralMemory?.memory || \"\",\n      specificMemory: existingSpecificMemory?.memory || \"\",\n    };\n  }\n\n  if (!key) {\n    // Update General Memory\n    const previousGeneralMemory = await getGeneralMemory(config.database_name);\n    const generalPrompt = await generatePrompt(\n      previousGeneralMemory,\n      general_prompt,\n      data\n    );\n    const generalResponse = await shinkaiLlmPromptProcessor({\n      format: \"text\",\n      prompt: generalPrompt,\n    });\n    const generalMemory = generalResponse.message;\n\n    if (previousGeneralMemory) {\n      const generalUpdateQuery = `\n              UPDATE memory_table SET memory = ?\n              WHERE id = ?\n          `;\n      await shinkaiSqliteQueryExecutor({\n        query: generalUpdateQuery,\n        params: [generalMemory, \"\" + previousGeneralMemory.id],\n        ...(config.database_name && { database_name: config.database_name }),\n      });\n    } else {\n      const generalInsertQuery = `\n            INSERT INTO memory_table (memory)\n            VALUES (?);\n        `;\n      await shinkaiSqliteQueryExecutor({\n        query: generalInsertQuery,\n        params: [generalMemory],\n        ...(config.database_name && { database_name: config.database_name }),\n      });\n    }\n    return { generalMemory, specificMemory: \"\" };\n  } else {\n    // Update specific memory\n    const previousSpecificMemory = await getSpecificMemory(\n      config.database_name,\n      key\n    );\n    const specificPrompt = await generatePrompt(\n      previousSpecificMemory,\n      specific_prompt,\n      data\n    );\n    const specificResponse = await shinkaiLlmPromptProcessor({\n      format: \"text\",\n      prompt: specificPrompt,\n    });\n    const specificMemory = specificResponse.message;\n\n    if (previousSpecificMemory) {\n      const specificUpdateQuery = `\n            UPDATE memory_table SET memory = ?\n            WHERE id = ?\n        `;\n      await shinkaiSqliteQueryExecutor({\n        query: specificUpdateQuery,\n        params: [specificMemory, \"\" + previousSpecificMemory.id],\n        ...(config.database_name && { database_name: config.database_name }),\n      });\n    } else {\n      const specificInsertQuery = `\n            INSERT INTO memory_table (key, memory)\n            VALUES (?, ?);\n        `;\n      await shinkaiSqliteQueryExecutor({\n        query: specificInsertQuery,\n        params: [key, specificMemory],\n        ...(config.database_name && { database_name: config.database_name }),\n      });\n    }\n    return { generalMemory: \"\", specificMemory };\n  }\n}\n","tools":["local:::__official_shinkai:::shinkai_sqlite_query_executor","local:::__official_shinkai:::shinkai_llm_prompt_processor"],"config":[{"BasicConfig":{"key_name":"database_name","description":"By default, the database name is the app_id. You can specify a different name to share the same database in multiple contexts.","required":false,"type":null,"key_value":null}}],"description":"Handles memory storage and retrieval using a SQLite database.","keywords":["memory","remember","management","recall","smart","agent"],"input_args":{"type":"object","properties":{"key":{"type":"string","description":"The key for specific memory retrieval"},"specific_prompt":{"type":"string","description":"The specific prompt for generating memories"},"data":{"type":"string","description":"The data to process for memory management, if not provided, the tool will return existing memories"},"general_prompt":{"type":"string","description":"The general prompt for generating memories"}},"required":[]},"output_arg":{"json":""},"activated":false,"embedding":[0.1117364,0.74066615,-0.12524469,-0.49450192,-0.25383872,-0.056793906,-0.80883753,0.13579896,0.24071765,-0.029963635,-0.47940955,0.9962987,-0.085171655,-0.08669497,0.41123724,-0.343977,0.2881898,0.8721878,-1.8125038,-0.06925787,0.37848657,0.44355488,0.077617615,-0.13606791,-0.1989142,0.10475354,0.07277657,-0.6413998,-0.8674754,-2.212483,0.23017034,0.8034553,-0.32316887,0.085311264,0.061779745,-0.5278791,-0.27159032,0.22947931,-1.0988287,-0.43523604,0.060649447,0.20976073,-0.6921853,0.1410698,0.3951202,-0.20934919,0.28317842,0.030886069,0.6607208,0.44044805,-0.34329888,-0.6634245,-0.4960957,0.031256407,-0.46245196,-0.11734384,-0.26726115,-0.12941422,-0.13201763,-0.5695283,-0.49054408,-0.033665046,-3.0541766,-0.35843447,0.44775862,0.118076295,0.60343176,0.030202085,-0.13934267,-0.11631434,-0.5127372,0.22292984,0.0016203709,0.43058524,0.01047419,-0.658974,0.54433495,-0.16644958,0.5963722,-0.56896204,0.58754635,0.68573046,0.057809137,-0.11267219,-0.36504355,0.21994759,-0.51731557,-0.034430027,0.20768398,0.10034765,-0.11141041,-0.35214412,0.041986246,-0.094716154,-0.4907499,0.501706,0.5427465,0.5309442,0.67431885,2.929547,0.60613817,-0.00528875,1.1125218,-0.5553954,0.5860213,-0.3967546,-0.0043556765,-0.26375335,-0.18946248,-0.04795447,0.5652242,0.040559735,0.10878344,0.36361083,0.3160663,-0.1491459,-0.90307,0.014223143,0.093262054,0.47609252,-1.2680926,0.15744355,-0.8016173,-0.07282586,-0.20279291,-0.24836579,-0.47434077,0.35821253,0.08987345,-0.8435928,0.17171273,-0.6059832,-1.525934,-0.09201673,0.15192617,0.029355332,0.09948828,-1.0534937,-0.84334487,-1.2044755,0.2218818,-1.8010815,1.257711,0.37106788,0.82655036,1.0648464,-0.073519915,-0.08289734,-0.32392207,-0.25770375,0.35046893,0.31085092,0.20939891,-0.17812899,0.8777044,-0.08618255,0.20614971,0.22159773,-0.5890746,-0.16454667,-0.6814425,-0.039333872,0.36462563,0.25442892,0.87361157,-1.1239793,-0.07609841,-0.4035873,0.4243467,-0.22381681,-0.036017492,0.07028975,0.051384155,0.2382396,0.10649441,-0.5527594,0.23846924,0.002401933,-0.08112009,-0.751719,-0.051750597,0.65853745,-0.2755794,-0.7393876,-0.30988896,-0.6519999,0.9836424,-0.094108485,0.046691917,0.98098755,-0.4468663,1.0436771,-0.874205,0.5285915,-0.24325609,-0.34917915,-0.09758468,0.6639509,0.6424557,-0.5623572,-0.34138894,-0.6115028,-0.15479517,0.093304306,0.6514433,-0.36582935,-0.33368018,0.0506187,0.41451335,-0.52436304,-0.22853298,-0.52046096,0.31947568,0.34198835,0.31179616,0.29937947,0.04178857,0.65257394,0.2345558,0.9933187,0.8801296,-0.06611996,0.48199403,-0.51863694,-0.226808,-0.7150427,-0.048097953,-0.4406157,-0.4336655,-0.5806268,0.23052976,0.8947172,0.8857983,0.15838063,0.5711899,0.03537724,0.26613635,0.36150932,0.42099303,-0.7847096,0.5707458,0.22814439,-0.41565818,-0.34700704,0.042060148,-0.2502401,0.3597543,0.35875472,0.43460783,1.2346184,0.8544298,0.43817762,-0.117669865,0.33193943,0.38009816,0.04977245,-1.7097088,0.122285984,-0.336572,0.30480215,0.48814857,0.0056697056,0.48117143,1.022925,0.4282231,0.18804163,-0.9280567,0.379702,0.1298311,-0.008329876,-0.7025105,1.1866246,-0.43537694,-0.41968855,-0.079343595,-0.7638508,0.7172403,-0.42081723,-0.34236163,-0.36758307,0.12557936,0.12207696,0.9030266,-0.023264155,-0.0480787,-0.1672036,-0.33187526,0.27297232,0.20791374,0.9202392,-0.19103932,-0.35380062,-0.7041526,0.85865945,1.4129078,1.355528,0.24946441,0.5236642,0.82622766,-0.12692997,0.06782467,0.4157075,-0.33701342,0.092960164,-0.18633343,0.002090633,0.55797285,0.38147277,-0.35872087,0.20970413,-1.2935344,0.13275324,0.13227452,-0.22442338,0.3649238,-0.5375568,0.47963083,1.4556811,-0.1739754,-2.0008068,-0.66098964,0.23619843,-0.14339764,-0.20242213,-0.13701333,0.20857678,-0.7433945,0.25042698,0.5428471,1.3143001,0.44823828,-0.8565997,-0.7582298,-0.43309197,0.94222176,0.40674824,0.554949,-0.1310741,-0.4225679,-0.07618262,0.5571718,1.2494824,0.4837056,0.05162667,-0.21357167,0.35025108,-0.54108554,-1.1716611,0.50939524,-0.62915194,-0.3729219,0.41225174,0.5995755,-0.3993328,0.7354395,1.1001024,0.24982806,0.24713251,-1.1759464,1.497135,-0.020245891,-0.31284398,-0.93299973,0.7780456,-0.34792125,-0.4102975,0.6559682,-0.14075074,-0.2797811,-0.22874439,-0.022727802,-0.2692985,0.16499844,0.450314,0.6070789,0.52864057,0.120737836,0.2574087,-0.3474483,0.104833364,1.0776329,0.4048078,-1.3007568,-0.40858728],"result":{"type":"object","properties":{"generalMemory":{"description":"The updated general memory","nullable":true,"type":"string"},"specificMemory":{"description":"The updated specific memory","nullable":true,"type":"string"}},"required":[]},"sql_tables":[{"name":"memory_table","definition":"CREATE TABLE IF NOT EXISTS memory_table (id INTEGER PRIMARY KEY AUTOINCREMENT, date DATETIME DEFAULT CURRENT_TIMESTAMP, key TEXT, memory TEXT)"}],"sql_queries":[{"name":"Get general memory","query":"SELECT id, key, memory FROM memory_table WHERE key IS NULL"},{"name":"Get specific memory","query":"SELECT id, key, memory FROM memory_table WHERE key = ?"},{"name":"Update memory","query":"UPDATE memory_table SET memory = ? WHERE id = ?"}],"file_inbox":null,"oauth":null,"assets":null,"runner":"any","operating_system":["linux","macos","windows"],"tool_set":""},false]}